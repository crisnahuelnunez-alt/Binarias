<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Riesgo Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-background-start: #1a1a2e; --color-background-mid: #16213e; --color-background-end: #0f3460;
            --color-primary: #00d4ff; --color-secondary: #00ff88; --color-tertiary: #a0a0a0;
            --color-text-light: #e0e0e0; --color-text-dark: #333; --color-card-background: rgba(22, 33, 62, 0.75);
            --color-card-border: rgba(255, 255, 255, 0.15); --color-input-background: rgba(0, 0, 0, 0.3);
            --color-win: #28a745; --color-loss: #dc3545; --color-warning: #ffc107;
            --border-radius-main: 15px; --border-radius-sm: 8px; --font-family-main: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family-main);
            background-color: var(--color-background-start);
            background-image:
                linear-gradient(135deg, var(--color-background-start) 0%, var(--color-background-mid) 50%, var(--color-background-end) 100%),
                url('assets/Gemini_Generated_Image_iogzlriogzlriogz.png');
            background-size: cover; background-position: center center; background-blend-mode: overlay;
            color: var(--color-text-light); min-height: 100vh; display: flex;
            justify-content: center; align-items: center; font-size: 16px;
            line-height: 1.6; padding: 30px;
        }
        .hidden { display: none !important; }
        #welcome-screen { text-align: center; max-width: 600px; width: 100%; padding: 40px; }
        #welcome-screen h1 {
            font-size: 3.5em; font-weight: 800; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.3); margin-bottom: 10px;
        }
        #welcome-screen p { font-size: 1.5em; color: var(--color-tertiary); margin-bottom: 40px; font-weight: 300; }
        .container { max-width: 960px; width: 100%; margin: 0 auto; }
        .card {
            background: var(--color-card-background); backdrop-filter: blur(15px);
            border: 1px solid var(--color-card-border);
            border-radius: var(--border-radius-main); padding: 35px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4); margin-bottom: 30px;
        }
        .card h2 {
            margin-bottom: 30px; color: var(--color-primary); font-size: 1.8em; font-weight: 700;
            border-bottom: 1px solid var(--color-card-border); padding-bottom: 18px;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
        }
        .input-group { margin-bottom: 25px; width: 100%; }
        .input-group label {
            display: block; margin-bottom: 10px; font-weight: 600; color: var(--color-tertiary);
            font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 16px; border: 1px solid transparent; border-radius: var(--border-radius-sm);
            background: var(--color-input-background); color: var(--color-text-light);
            font-size: 1.05em; transition: border-color 0.3s, box-shadow 0.3s; font-family: var(--font-family-main);
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none; border-color: var(--color-primary);
            box-shadow: 0 0 18px rgba(0, 212, 255, 0.3);
        }
        .input-with-symbol { position: relative; }
        .input-with-symbol span { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--color-tertiary); font-size: 1.1em; font-weight: 600; pointer-events: none; }
        .input-with-symbol input { padding-left: 40px !important; }
        .split-inputs { display: flex; gap: 25px; flex-wrap: wrap; }
        .split-inputs .input-group { flex: 1; min-width: 280px; }
        .btn, .btn-primary, .btn-secondary {
            color: var(--color-text-dark); border: none; padding: 18px 35px; border-radius: var(--border-radius-sm);
            font-size: 1.15em; font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px;
            text-transform: uppercase; letter-spacing: 0.8px;
        }
        .btn-primary { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); }
        .btn-secondary { background: #6c757d; color: white; font-size: 0.8em; padding: 8px 15px; width: auto; margin-top: 0; }
        .btn-win { background-color: var(--color-win); color: white; }
        .btn-loss { background-color: var(--color-loss); color: white; }
        .investment-amount { font-size: 4.5em; font-weight: 800; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; line-height: 1.2; text-shadow: 0 0 20px rgba(0, 212, 255, 0.5); text-align: center; }
        .action-buttons { display: flex; gap: 20px; margin-top: 20px; }
        #phase-display { font-size: 1em; color: var(--color-warning); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2); border-radius: var(--border-radius-main); overflow: hidden; }
        th, td { padding: 18px; text-align: center; border-bottom: 1px solid var(--color-card-border); }
        th { background: rgba(0, 0, 0, 0.3); color: var(--color-primary); font-weight: 700; }
        .win-row { background: rgba(0, 255, 136, 0.1); }
        .loss-row { background: rgba(255, 0, 68, 0.1); }
        .warning-text {
            color: var(--color-warning);
            font-size: 0.9em;
            border: 1px solid var(--color-warning);
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            margin-top: 10px;
            margin-bottom: 30px;
            background-color: rgba(255, 193, 7, 0.05);
        }
        @media (max-width: 768px) {
            .investment-amount { font-size: 5em; }
            .action-buttons { flex-direction: column; }
            .action-buttons .btn { width: 100%; padding: 20px; font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <h1>Gestión de Riesgo Pro</h1>
        <p>Dominando Binarias</p>
        
        <div class="input-group">
            <label for="initial-balance">¿Cuál es tu capital para la sesión?</label>
            <div class="input-with-symbol">
                <span>$</span>
                <input type="number" id="initial-balance" placeholder="Ej: 100" min="1">
            </div>
        </div>
        
        <div class="warning-text">
            ⚠️ Recuerda: Tu capital está en riesgo. Opera con responsabilidad.
        </div>

        <button class="btn-primary" id="start-session-btn">Iniciar Sesión</button>
    </div>

    <div id="dashboard" class="container hidden">
        <div id="setup-card" class="card">
            <h2><span class="icon">⚙️</span> Plan de Sesión</h2>
            <div class="input-group">
                <label for="strategy">Estrategia de Gestión de Riesgo</label>
                <select id="strategy">
                    <option value="masaniello">Progresión de Ciclo (Masaniello)</option>
                    <option value="martingale">Martingala (Clásica)</option>
                    <option value="kelly">Criterio de Kelly (Óptimo)</option>
                </select>
            </div>
            <div id="strategy-info-box" style="margin-bottom: 25px; padding: 15px; border-left: 4px solid; border-radius: 8px; font-size: 0.9em; line-height: 1.5;"></div>

            <div class="input-group">
                <label for="balance">Balance de Sesión</label>
                <div class="input-with-symbol">
                    <span>$</span>
                    <input type="number" id="balance" readonly>
                </div>
            </div>
            
            <div id="masaniello-group">
                <div class="split-inputs">
                    <div class="input-group">
                        <label for="total-trades">Cantidad de Operaciones</label>
                        <input type="number" id="total-trades" value="10" min="2">
                    </div>
                    <div class="input-group">
                        <label for="expected-wins">Ganadas Esperadas</label>
                        <input type="number" id="expected-wins" value="4" min="1">
                    </div>
                </div>
            </div>

            <div id="other-strategies-group" class="hidden">
                <div id="standard-params-group">
                    <div class="split-inputs">
                        <div class="input-group">
                            <label for="sessionProfitGoal">Take Profit (%)</label>
                            <input type="number" id="sessionProfitGoal" value="20" min="1">
                        </div>
                        <div class="input-group">
                            <label for="stopLossPercent">Stop-Loss (%)</label>
                            <input type="number" id="stopLossPercent" value="25" min="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="split-inputs">
                <div class="input-group">
                    <label for="payoutRate">Payout del Broker (%)</label>
                    <input type="number" id="payoutRate" value="87" step="0.1">
                </div>
                <div class="input-group" style="justify-content: center; align-items: center; display: flex; padding-top: 15px;">
                    <input type="checkbox" id="allowDecimals" checked style="width: auto; height: 18px; accent-color: var(--color-primary); margin-right: 12px;">
                    <label for="allowDecimals" style="margin-bottom: 0; text-transform: none; font-weight: 400; color: var(--color-text-light); cursor: pointer;">
                        Permitir decimales
                    </label>
                </div>
            </div>
            
            <button class="btn-primary" id="startBtn">▶️ Comenzar Operativa</button>
        </div>
        <div id="live-card" class="card hidden">
            <h2>
                <span><span class="icon">🔴</span> Panel de Operación</span>
                <button id="back-to-setup-btn" class="btn-secondary">⬅️ Volver a Configurar</button>
            </h2>
            <div id="live-panel-content" style="text-align: center;">
                <h3 id="operation-label"></h3>
                <div id="phase-display"></div>
                <div id="investment-amount" class="investment-amount"></div>
                <div class="action-buttons">
                    <button class="btn btn-win" id="winBtn">Gané ✅</button>
                    <button class="btn btn-loss" id="lossBtn">Perdí ❌</button>
                </div>
            </div>
        </div>
        <div id="history-card" class="card hidden">
            <h2><span class="icon">📋</span> Historial de la Sesión</h2>
            <div id="tableContent"></div>
        </div>
        <div id="journal-card" class="card hidden">
            <h2><span class="icon">✍️</span> Análisis de la Sesión</h2>
            <div id="journal-summary" style="margin-bottom: 25px;"></div>
            <div class="input-group">
                <label for="journal-notes">Mis Notas de la Sesión</label>
                <textarea id="journal-notes" rows="4" placeholder="¿Qué aprendiste hoy? ¿Seguiste tu plan al 100%?"></textarea>
            </div>
            <button class="btn-primary" id="save-session-btn">Guardar Sesión y Volver al Inicio</button>
        </div>
    </div>

    <script>
        const state = {
            strategy: 'masaniello',
            payoutMasa: 1.87, payoutOthers: 0.87,
            initialBalance: 0, minInvestment: 0.01,
            sessionProfitGoal: 20, stopLossPercent: 25, stopLossTriggerAmount: 0,
            takeProfitTriggerAmount: 0, currentBalance: 0, operationNumber: 1, 
            lastInvestment: 0, history: [], lossesToRecover: 0,
            masaniello: { totalTrades: 0, expectedWins: 0, winsSoFar: 0, tradesDone: 0 }
        };

        const masanielloMath = {
            calculateFirstInvestment(capital, totalTrades, expectedWins, payout) {
                let C = 1;
                let T = 0;
                let E = 0;
                for (let i = 0; i <= totalTrades - expectedWins; i++) {
                    E = expectedWins + i;
                    T += this.combinations(E - 1, expectedWins - 1) * Math.pow(payout - 1, expectedWins) * Math.pow(1, i);
                }
                C = T / Math.pow(payout, totalTrades);
                const firstBet = (capital * C) / (1 - C);
                return firstBet;
            },
            combinations(n, k) {
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k;
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return res;
            }
        };

        const ui = {
            elements: {
                welcomeScreen: document.getElementById('welcome-screen'), dashboard: document.getElementById('dashboard'),
                startSessionBtn: document.getElementById('start-session-btn'), initialBalanceInput: document.getElementById('initial-balance'),
                balanceInput: document.getElementById('balance'), setupCard: document.getElementById('setup-card'),
                liveCard: document.getElementById('live-card'), historyCard: document.getElementById('history-card'),
                operationLabel: document.getElementById('operation-label'), investmentAmount: document.getElementById('investment-amount'),
                tableContent: document.getElementById('tableContent'), strategySelect: document.getElementById('strategy'),
                strategyInfoBox: document.getElementById('strategy-info-box'),
                startBtn: document.getElementById('startBtn'), winBtn: document.getElementById('winBtn'),
                lossBtn: document.getElementById('lossBtn'),
                journalCard: document.getElementById('journal-card'), journalSummary: document.getElementById('journal-summary'),
                journalNotes: document.getElementById('journal-notes'),
                saveSessionBtn: document.getElementById('save-session-btn'),
                backToSetupBtn: document.getElementById('back-to-setup-btn'),
                phaseDisplay: document.getElementById('phase-display'),
                allowDecimals: document.getElementById('allowDecimals'),
                masanielloGroup: document.getElementById('masaniello-group'),
                otherStrategiesGroup: document.getElementById('other-strategies-group')
            },
            showDashboard() { this.elements.welcomeScreen.classList.add('hidden'); this.elements.dashboard.classList.remove('hidden'); document.body.style.alignItems = 'flex-start'; },
            showWelcomeScreen() {
                this.elements.dashboard.classList.add('hidden');
                this.elements.welcomeScreen.classList.remove('hidden');
                document.body.style.alignItems = 'center';
            },
            showSetup() {
                this.elements.liveCard.classList.add('hidden');
                this.elements.historyCard.classList.add('hidden');
                this.elements.journalCard.classList.add('hidden');
                this.elements.setupCard.classList.remove('hidden');
            },
            updateLivePanel(opNum, totalOps, amountText) {
                this.elements.operationLabel.innerText = `OPERACIÓN #${opNum} de ${totalOps}`;
                this.elements.investmentAmount.innerText = amountText;
                this.elements.phaseDisplay.innerText = '';
            },
            renderHistoryTable(history) {
                let tableHTML = `<table><thead><tr><th>Op#</th><th>Invertido</th><th>Resultado</th><th>G/P</th><th>Balance</th></tr></thead><tbody>`;
                history.forEach(op => {
                    const rowClass = op.result === 'WIN' ? 'win-row' : 'loss-row';
                    const resultColor = op.netResult >= 0 ? 'var(--color-secondary)' : 'var(--color-loss)';
                    tableHTML += `<tr class="${rowClass}"><td>${op.op}</td><td>$${op.investment.toFixed(2)}</td><td>${op.result}</td><td style="color: ${resultColor}">$${op.netResult.toFixed(2)}</td><td>$${op.balance.toFixed(2)}</td></tr>`;
                });
                this.elements.tableContent.innerHTML = tableHTML + '</tbody></table>';
            },
            showLiveMode() { this.elements.setupCard.classList.add('hidden'); this.elements.liveCard.classList.remove('hidden'); this.elements.historyCard.classList.remove('hidden'); },
            updateStrategyInfo(strategy) {
                let info = {}; const infoBox = this.elements.strategyInfoBox;
                switch (strategy) {
                    case 'masaniello': info = { borderColor: 'var(--color-primary)', title: '<strong>Riesgo:</strong> Calculado', description: '<strong>Ideal para:</strong> Alcanzar un objetivo con una tasa de aciertos predefinida.', warning: '<strong>Advertencia:</strong> Si fallas más de lo permitido, pierdes todo el capital del ciclo.' }; break;
                    case 'martingale': info = { borderColor: 'var(--color-warning)', title: '<strong>Riesgo:</strong> Alto', description: '<strong>Ideal para:</strong> Recuperación de pérdidas simple.', warning: '<strong>Advertencia:</strong> Peligroso en rachas de pérdidas.' }; break;
                    case 'kelly': info = { borderColor: 'var(--color-secondary)', title: '<strong>Riesgo:</strong> Moderado', description: '<strong>Ideal para:</strong> Crecimiento óptimo a largo plazo.', warning: '<strong>Advertencia:</strong> Fija una tasa de aciertos del 60%.' }; break;
                }
                infoBox.style.borderColor = info.borderColor; infoBox.innerHTML = `<p>${info.title}</p><p>${info.description}</p><p style="opacity: 0.8;">${info.warning}</p>`;
            }
        };
        const sessionManager = {
            start() {
                try {
                    state.strategy = ui.elements.strategySelect.value;
                    state.initialBalance = parseFloat(ui.elements.initialBalanceInput.value);
                    state.currentBalance = state.initialBalance;
                    const payoutInput = parseFloat(document.getElementById('payoutRate').value);
                    state.payoutMasa = 1 + (payoutInput / 100);
                    state.payoutOthers = payoutInput / 100;

                    if (state.strategy === 'masaniello') {
                        state.masaniello.totalTrades = parseInt(document.getElementById('total-trades').value);
                        state.masaniello.expectedWins = parseInt(document.getElementById('expected-wins').value);
                        state.masaniello.tradesDone = 0;
                        state.masaniello.winsSoFar = 0;
                        if (state.masaniello.expectedWins >= state.masaniello.totalTrades) {
                            alert("Las ganadas esperadas deben ser menores que el total de operaciones.");
                            return;
                        }
                    } else {
                        state.minInvestment = 0.01;
                        state.sessionProfitGoal = parseFloat(document.getElementById('sessionProfitGoal').value);
                        state.stopLossPercent = parseFloat(document.getElementById('stopLossPercent').value);
                        state.stopLossTriggerAmount = state.initialBalance * (1 - (state.stopLossPercent / 100));
                        state.takeProfitTriggerAmount = state.initialBalance * (1 + (state.sessionProfitGoal / 100));
                    }
                } catch (e) { alert('Error en la configuración: ' + e.message); return; }

                state.operationNumber = 1; 
                state.history = []; 
                state.lossesToRecover = 0;
                ui.showLiveMode(); 
                this.calculateNextInvestment();
            },
            calculateNextInvestment() {
                let finalInvestment = 0;
                let totalOps = '∞';
                
                if (state.strategy === 'masaniello') {
                    const m = state.masaniello;
                    totalOps = m.totalTrades;
                    if (m.tradesDone === 0) {
                        m.initialBet = masanielloMath.calculateFirstInvestment(state.initialBalance, m.totalTrades, m.expectedWins, state.payoutMasa);
                        finalInvestment = m.initialBet;
                    } else {
                        const lastOp = state.history[state.history.length - 1];
                        if (lastOp.result === 'WIN') {
                            finalInvestment = state.lastInvestment * state.payoutMasa / state.payoutMasa; // Se mantiene igual
                        } else { // LOSS
                             finalInvestment = state.lastInvestment * (m.totalTrades - m.tradesDone + 1) / (m.totalTrades - m.expectedWins - (m.tradesDone - m.winsSoFar));
                        }
                    }
                } else {
                    if (state.strategy === 'kelly') {
                        const kellyFraction = 0.60 - ((1 - 0.60) / state.payoutOthers);
                        finalInvestment = (kellyFraction > 0) ? state.currentBalance * kellyFraction : state.minInvestment;
                    } else if (state.strategy === 'martingale') {
                        const targetProfit = state.initialBalance * 0.02; 
                        finalInvestment = (state.lossesToRecover + targetProfit) / state.payoutOthers;
                    }
                    finalInvestment = Math.max(finalInvestment, state.minInvestment);
                }
                
                if (!ui.elements.allowDecimals.checked) {
                    finalInvestment = Math.round(finalInvestment);
                }

                state.lastInvestment = finalInvestment > state.currentBalance ? state.currentBalance : finalInvestment;
                ui.updateLivePanel(state.operationNumber, totalOps, `$${state.lastInvestment.toFixed(2)}`);
            },
            logResult(isWin) {
                const investment = state.lastInvestment;
                if (investment <= 0) { this.end(state.currentBalance > state.initialBalance); return; }

                let netResult = 0;
                if (state.strategy === 'masaniello') {
                    netResult = isWin ? investment * (state.payoutMasa - 1) : -investment;
                } else {
                    netResult = isWin ? investment * state.payoutOthers : -investment;
                }

                state.currentBalance += netResult;

                if (state.strategy === 'masaniello') {
                    state.masaniello.tradesDone++;
                    if (isWin) state.masaniello.winsSoFar++;
                } else if (state.strategy === 'martingale') {
                    if (!isWin) { state.lossesToRecover += investment; } else { state.lossesToRecover = 0; }
                }
                
                state.history.push({ op: state.operationNumber, investment, result: isWin ? 'WIN' : 'LOSS', netResult, balance: state.currentBalance });
                ui.renderHistoryTable(state.history);

                let isSessionOver = false;
                const m = state.masaniello;
                if (state.strategy === 'masaniello') {
                    const remainingTrades = m.totalTrades - m.tradesDone;
                    const remainingWins = m.expectedWins - m.winsSoFar;
                    if (remainingWins <= 0) { isSessionOver = true; } 
                    if (remainingWins > remainingTrades) { isSessionOver = true; }
                    if (m.tradesDone >= m.totalTrades) { isSessionOver = true; }
                } else {
                    isSessionOver = (state.currentBalance <= state.stopLossTriggerAmount || state.currentBalance >= state.takeProfitTriggerAmount);
                }

                if (isSessionOver) {
                    this.end(state.currentBalance > state.initialBalance);
                } else {
                    state.operationNumber++; 
                    this.calculateNextInvestment();
                }
            },
            end(isVictory) {
                ui.elements.liveCard.classList.add('hidden'); ui.elements.historyCard.classList.add('hidden');
                const profitLoss = state.currentBalance - state.initialBalance;
                const totalOps = state.history.length;
                let resultText = isVictory ? 'Sesión en Ganancia' : 'Sesión en Pérdida';
                
                if(state.strategy === 'masaniello') {
                    resultText = state.masaniello.winsSoFar >= state.masaniello.expectedWins ? '¡Ciclo Exitoso!' : 'Ciclo Fallido';
                }

                const resultColor = (resultText === '¡Ciclo Exitoso!' || (state.strategy !== 'masaniello' && isVictory)) ? 'var(--color-win)' : 'var(--color-loss)';
                ui.elements.journalSummary.innerHTML = `<p style="font-size: 1.4em;"><strong>Resultado:</strong> <span style="color: ${resultColor};">${resultText}</span></p><p>Balance Final: $${state.currentBalance.toFixed(2)} ($${profitLoss.toFixed(2)})</p><p><strong>Operaciones Totales:</strong> ${totalOps}</p>`;
                ui.elements.journalCard.classList.remove('hidden');
            },
            reset() {
                ui.elements.journalNotes.value = '';
                ui.elements.journalCard.classList.add('hidden');
                ui.elements.liveCard.classList.add('hidden');
                ui.elements.historyCard.classList.add('hidden');
                ui.elements.setupCard.classList.remove('hidden');
                ui.showWelcomeScreen();
            }
        };
        const app = {
            init() {
                ui.elements.startSessionBtn.addEventListener('click', () => {
                    const initialBalance = ui.elements.initialBalanceInput.value;
                    if (parseFloat(initialBalance) > 0) { 
                        ui.elements.balanceInput.value = initialBalance; 
                        ui.showDashboard(); 
                    } else { 
                        alert("Por favor, introduce un balance válido."); 
                    }
                });
                ui.elements.startBtn.addEventListener('click', () => sessionManager.start());
                ui.elements.winBtn.addEventListener('click', () => sessionManager.logResult(true));
                ui.elements.lossBtn.addEventListener('click', () => sessionManager.logResult(false));
                document.getElementById('save-session-btn').addEventListener('click', () => sessionManager.reset());
                ui.elements.backToSetupBtn.addEventListener('click', () => sessionManager.reset());
                
                ui.elements.strategySelect.addEventListener('change', (e) => {
                    const strategy = e.target.value;
                    const isMasaniello = strategy === 'masaniello';
                    ui.elements.masanielloGroup.classList.toggle('hidden', !isMasaniello);
                    ui.elements.otherStrategiesGroup.classList.toggle('hidden', isMasaniello);
                    ui.updateStrategyInfo(strategy);
                });
                ui.updateStrategyInfo('masaniello');
            }
        };
        app.init();
    </script>
</body>
</html>

