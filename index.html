<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Riesgo Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-background-start: #1a1a2e; --color-background-mid: #16213e; --color-background-end: #0f3460;
            --color-primary: #00d4ff; --color-secondary: #00ff88; --color-tertiary: #a0a0a0;
            --color-text-light: #e0e0e0; --color-text-dark: #333; --color-card-background: rgba(22, 33, 62, 0.75);
            --color-card-border: rgba(255, 255, 255, 0.15); --color-input-background: rgba(0, 0, 0, 0.3);
            --color-win: #28a745; --color-loss: #dc3545; --color-warning: #ffc107;
            --border-radius-main: 15px; --border-radius-sm: 8px; --font-family-main: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family-main);
            background-color: var(--color-background-start);
            color: var(--color-text-light); min-height: 100vh; display: flex;
            justify-content: center; align-items: center; font-size: 16px;
            line-height: 1.6; padding: 30px;
        }
        .hidden { display: none !important; }
        #welcome-screen { text-align: center; max-width: 600px; width: 100%; padding: 40px; }
        #welcome-screen h1 {
            font-size: 3.5em; font-weight: 800; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #welcome-screen p { font-size: 1.5em; color: var(--color-tertiary); margin-bottom: 40px; font-weight: 300; }
        .container { max-width: 960px; width: 100%; margin: 0 auto; }
        .card {
            background: var(--color-card-background); backdrop-filter: blur(15px);
            border: 1px solid var(--color-card-border);
            border-radius: var(--border-radius-main); padding: 35px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4); margin-bottom: 30px;
        }
        .card h2 {
            margin-bottom: 30px; color: var(--color-primary); font-size: 1.8em; font-weight: 700;
            border-bottom: 1px solid var(--color-card-border); padding-bottom: 18px;
        }
        .input-group { margin-bottom: 25px; width: 100%; }
        .input-group label {
            display: block; margin-bottom: 10px; font-weight: 600; color: var(--color-tertiary);
            font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 16px; border-radius: var(--border-radius-sm);
            background: var(--color-input-background); color: var(--color-text-light);
            font-size: 1.05em; border: 1px solid transparent; 
        }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: var(--color-primary);
        }
        .input-with-symbol { position: relative; }
        .input-with-symbol span { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--color-tertiary);}
        .input-with-symbol input { padding-left: 40px !important; }
        .split-inputs { display: flex; gap: 25px; flex-wrap: wrap; }
        .split-inputs .input-group { flex: 1; min-width: 250px; }
        .btn, .btn-primary, .btn-secondary {
            border: none; padding: 18px 35px; border-radius: var(--border-radius-sm);
            font-size: 1.15em; font-weight: 700; cursor: pointer; width: 100%;
        }
        .btn-primary { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-text-dark); }
        .btn-secondary { background: #6c757d; color: white; font-size: 0.8em; padding: 8px 15px; width: auto; margin-top: 0; }
        .btn-win { background-color: var(--color-win); color: white; }
        .btn-loss { background-color: var(--color-loss); color: white; }
        .investment-amount { font-size: 4.5em; font-weight: 800; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; line-height: 1.2; text-align: center; }
        .action-buttons { display: flex; gap: 20px; margin-top: 20px; }
        #phase-display { font-size: 1em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700;}
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 18px; text-align: center; border-bottom: 1px solid var(--color-card-border); }
        th { color: var(--color-primary); }
        .win-row { background: rgba(0, 255, 136, 0.1); }
        .loss-row { background: rgba(255, 0, 68, 0.1); }
        .warning-text { color: var(--color-warning); font-size: 0.9em; border: 1px solid var(--color-warning); padding: 10px 15px; border-radius: var(--border-radius-sm); margin-bottom: 30px;}
    </style>
</head>
<body>
    <div id="welcome-screen">
        <h1>Gestión de Riesgo Pro</h1>
        <p>Dominando Binarias</p>
        <div class="input-group">
            <label for="initial-balance">¿Cuál es tu capital para la sesión?</label>
            <div class="input-with-symbol">
                <span>$</span>
                <input type="number" id="initial-balance" placeholder="Ej: 100" min="1">
            </div>
        </div>
        <div class="warning-text">⚠️ Recuerda: Tu capital está en riesgo. Opera con responsabilidad.</div>
        <button class="btn-primary" id="start-session-btn">Iniciar Sesión</button>
    </div>

    <div id="dashboard" class="container hidden">
        <div id="setup-card" class="card">
            <h2><span class="icon">⚙️</span> Plan de Sesión</h2>
            <div class="input-group">
                <label for="strategy">Estrategia de Gestión de Riesgo</label>
                <select id="strategy">
                    <option value="gemhuel">Estrategia Gemhuel</option>
                    <option value="masaniello">Progresión de Ciclo (Masaniello)</option>
                </select>
            </div>
            <div id="strategy-info-box" style="margin-bottom: 25px; padding: 15px; border-left: 4px solid; border-radius: 8px; font-size: 0.9em; line-height: 1.5;"></div>
            <div id="masaniello-group" class="hidden">
                <div class="split-inputs">
                    <div class="input-group"><label for="total-trades-masa">Total Operaciones</label><input type="number" id="total-trades-masa" value="10"></div>
                    <div class="input-group"><label for="expected-wins">Ganadas Esperadas</label><input type="number" id="expected-wins" value="4"></div>
                </div>
            </div>
            <div id="gemhuel-group">
                <div class="split-inputs">
                    <div class="input-group"><label for="accumulation-investment-percent">Inversión Acumulación (%)</label><input type="number" id="accumulation-investment-percent" value="2"></div>
                    <div class="input-group"><label for="accumulation-goal-percent">Meta Acumulación (%)</label><input type="number" id="accumulation-goal-percent" value="10"></div>
                    <div class="input-group"><label for="attack-trades">Operaciones de Ataque</label><input type="number" id="attack-trades" value="3"></div>
                </div>
            </div>
            <div class="split-inputs">
                <div class="input-group"><label for="payoutRate">Payout del Broker (%)</label><input type="number" id="payoutRate" value="87"></div>
                <div class="input-group" style="justify-content: center; align-items: center; display: flex; padding-top: 15px;">
                    <input type="checkbox" id="allowDecimals" checked style="width: auto; height: 18px; margin-right: 12px;"><label for="allowDecimals" style="margin: 0;">Permitir decimales</label>
                </div>
            </div>
            <button class="btn-primary" id="startBtn">▶️ Comenzar Operativa</button>
        </div>
        <div id="live-card" class="card hidden">
            <h2>Panel de Operación</h2>
            <div style="text-align: center;">
                <div id="phase-display"></div>
                <h3 id="operation-label"></h3>
                <div id="investment-amount" class="investment-amount"></div>
                <div class="action-buttons"><button class="btn btn-win" id="winBtn">Gané ✅</button><button class="btn btn-loss" id="lossBtn">Perdí ❌</button></div>
            </div>
        </div>
        <div id="history-card" class="card hidden">
            <h2>Historial de la Sesión</h2>
            <div id="tableContent"></div>
        </div>
        <div id="journal-card" class="card hidden">
            <h2>Análisis de la Sesión</h2>
            <div id="journal-summary" style="margin-bottom: 25px;"></div>
            <button class="btn-primary" id="save-session-btn">Volver al Inicio</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const App = {
                state: {},

                ui: {
                    welcomeScreen: document.getElementById('welcome-screen'),
                    dashboard: document.getElementById('dashboard'),
                    setupCard: document.getElementById('setup-card'),
                    liveCard: document.getElementById('live-card'),
                    historyCard: document.getElementById('history-card'),
                    journalCard: document.getElementById('journal-card'),
                    startSessionBtn: document.getElementById('start-session-btn'),
                    startBtn: document.getElementById('startBtn'),
                    winBtn: document.getElementById('winBtn'),
                    lossBtn: document.getElementById('lossBtn'),
                    saveSessionBtn: document.getElementById('save-session-btn'),
                    initialBalanceInput: document.getElementById('initial-balance'),
                    operationLabel: document.getElementById('operation-label'),
                    investmentAmount: document.getElementById('investment-amount'),
                    tableContent: document.getElementById('tableContent'),
                    journalSummary: document.getElementById('journal-summary'),
                    strategySelect: document.getElementById('strategy'),
                    strategyInfoBox: document.getElementById('strategy-info-box'),
                    masanielloGroup: document.getElementById('masaniello-group'),
                    gemhuelGroup: document.getElementById('gemhuel-group'),
                    allowDecimals: document.getElementById('allowDecimals'),
                    payoutRateInput: document.getElementById('payoutRate'),
                    phaseDisplay: document.getElementById('phase-display'),
                },

                math: {
                    combinations(n, k) { if (k < 0 || k > n) return 0; if (k === 0 || k === n) return 1; if (k > n / 2) k = n - k; let r = 1; for (let i = 1; i <= k; i++) { r = r * (n - i + 1) / i; } return r; },
                    calculateFirstInvestment(K, N, E, Q) { let C = 1, T = 0, Ev = 0; for (let i = 0; i <= N - E; i++) { Ev = E + i; T += this.combinations(Ev - 1, E - 1) * Math.pow(Q - 1, E) * Math.pow(1, i); } C = T / Math.pow(Q, N); if (C >= 1) return K; return (K * C) / (1 - C); }
                },

                init() {
                    this.resetApp();
                    this.bindEvents();
                    this.updateUI();
                },
                
                resetState() {
                    this.state = {
                        initialBalance: 0, currentBalance: 0, operationNumber: 1, lastInvestment: 0, history: [],
                        strategy: 'gemhuel', payout: 0.87,
                        gemhuel: { phase: 'Acumulación', accumulationGoal: 0, profitForAttack: 0, attackTradesCount: 0, attackInvestment: 0, accumulationInvestment: 0, attackTrades: 3 },
                        masaniello: { totalTrades: 10, expectedWins: 4, winsSoFar: 0, tradesDone: 0 }
                    };
                },

                bindEvents() {
                    this.ui.startSessionBtn.addEventListener('click', () => this.initSession());
                    this.ui.startBtn.addEventListener('click', () => this.startTrading());
                    this.ui.winBtn.addEventListener('click', () => this.logResult(true));
                    this.ui.lossBtn.addEventListener('click', () => this.logResult(false));
                    this.ui.saveSessionBtn.addEventListener('click', () => this.resetApp());
                    this.ui.strategySelect.addEventListener('change', () => this.updateUI());
                },
                
                resetApp() {
                    this.resetState();
                    this.ui.welcomeScreen.classList.remove('hidden');
                    this.ui.dashboard.classList.add('hidden');
                    this.ui.setupCard.classList.remove('hidden');
                    this.ui.liveCard.classList.add('hidden');
                    this.ui.historyCard.classList.add('hidden');
                    this.ui.journalCard.classList.add('hidden');
                    this.ui.initialBalanceInput.value = '';
                    this.ui.tableContent.innerHTML = '';
                    this.updateUI();
                },

                initSession() {
                    const balance = parseFloat(this.ui.initialBalanceInput.value);
                    if (balance > 0) {
                        this.resetState();
                        this.state.initialBalance = balance;
                        this.state.currentBalance = balance;
                        this.ui.dashboard.classList.remove('hidden');
                        this.ui.welcomeScreen.classList.add('hidden');
                    } else { alert("Introduce un balance válido."); }
                },

                startTrading() {
                    this.state.strategy = this.ui.strategySelect.value;
                    this.state.payout = parseFloat(this.ui.payoutRateInput.value) / 100;
                    
                    if (this.state.strategy === 'masaniello') {
                        this.state.masaniello.totalTrades = parseInt(document.getElementById('total-trades-masa').value);
                        this.state.masaniello.expectedWins = parseInt(document.getElementById('expected-wins').value);
                    } else {
                        const accumulationInvestmentPercent = parseFloat(document.getElementById('accumulation-investment-percent').value);
                        const accumulationGoalPercent = parseFloat(document.getElementById('accumulation-goal-percent').value);
                        this.state.gemhuel.accumulationInvestment = this.state.initialBalance * (accumulationInvestmentPercent / 100);
                        this.state.gemhuel.accumulationGoal = this.state.initialBalance * (1 + accumulationGoalPercent / 100);
                        this.state.gemhuel.attackTrades = parseInt(document.getElementById('attack-trades').value);
                    }
                    
                    this.ui.liveCard.classList.remove('hidden');
                    this.ui.historyCard.classList.remove('hidden');
                    this.ui.setupCard.classList.add('hidden');
                    this.calculateNextInvestment();
                },

                calculateNextInvestment() {
                    let investment = 0;
                    
                    if (this.state.strategy === 'gemhuel') {
                        const g = this.state.gemhuel;
                        if (g.phase === 'Acumulación') {
                            investment = g.accumulationInvestment;
                        } else { // Ataque
                            investment = g.attackInvestment;
                        }
                    } else { // Masaniello
                        const m = this.state.masaniello;
                        const payoutMasa = 1 + this.state.payout;
                        if (m.tradesDone === 0) {
                            investment = this.math.calculateFirstInvestment(this.state.initialBalance, m.totalTrades, m.expectedWins, payoutMasa);
                        } else {
                            const lastOp = this.state.history[this.state.history.length - 1];
                            investment = lastOp.result === 'WIN' ? this.state.lastInvestment : this.state.lastInvestment * (m.totalTrades - m.tradesDone + 1) / (m.totalTrades - m.expectedWins - (m.tradesDone - m.winsSoFar));
                        }
                    }

                    if (!this.ui.allowDecimals.checked) investment = Math.round(investment);
                    this.state.lastInvestment = investment > this.state.currentBalance ? this.state.currentBalance : investment;
                    
                    this.updateLivePanel();
                },
                
                logResult(isWin) {
                    const investment = this.state.lastInvestment;
                    if (investment < 0.01 && this.state.operationNumber > 1) { this.endSession(); return; }

                    const payout = this.state.strategy === 'masaniello' ? 1 + this.state.payout : this.state.payout;
                    const netResult = isWin ? investment * (this.state.strategy === 'masaniello' ? payout - 1 : payout) : -investment;
                    this.state.currentBalance += netResult;

                    this.state.history.push({ op: this.state.operationNumber, investment, result: isWin ? 'WIN' : 'LOSS', netResult, balance: this.state.currentBalance });

                    // --- STRATEGY-SPECIFIC LOGIC ---
                    if (this.state.strategy === 'gemhuel') {
                        const g = this.state.gemhuel;
                        if (g.phase === 'Acumulación' && this.state.currentBalance >= g.accumulationGoal) {
                            g.phase = 'Ataque';
                            g.profitForAttack = this.state.currentBalance - this.state.initialBalance;
                            g.attackInvestment = g.profitForAttack / g.attackTrades;
                            g.attackTradesCount = 0;
                        } else if (g.phase === 'Ataque') {
                            g.attackTradesCount++;
                            if (!isWin || g.attackTradesCount >= g.attackTrades) {
                                g.phase = 'Acumulación'; // Cycle ends, reset to accumulation
                            }
                        }
                    } else { // Masaniello
                        this.state.masaniello.tradesDone++;
                        if (isWin) this.state.masaniello.winsSoFar++;
                    }
                    
                    this.renderHistory();

                    let sessionOver = false;
                    if (this.state.strategy === 'masaniello') {
                        const m = this.state.masaniello;
                        const remTrades = m.totalTrades - m.tradesDone;
                        const remWins = m.expectedWins - m.winsSoFar;
                        if (remWins <= 0 || remWins > remTrades || m.tradesDone >= m.totalTrades) sessionOver = true;
                    }
                    if (this.state.currentBalance <= 0) sessionOver = true;
                    
                    if (sessionOver) {
                        this.endSession();
                    } else {
                        this.state.operationNumber++; 
                        this.calculateNextInvestment();
                    }
                },

                endSession() {
                    const isVictory = this.state.currentBalance > this.state.initialBalance;
                    this.ui.liveCard.classList.add('hidden');
                    this.ui.historyCard.classList.add('hidden');
                    const profitLoss = this.state.currentBalance - this.state.initialBalance;
                    let resultText = isVictory ? 'Sesión en Ganancia' : 'Sesión en Pérdida';
                    
                    if(this.state.strategy === 'masaniello') {
                        resultText = this.state.masaniello.winsSoFar >= this.state.masaniello.expectedWins ? '¡Ciclo Masaniello Exitoso!' : 'Ciclo Masaniello Fallido';
                    }

                    const resultColor = (resultText.includes('Exitoso') || resultText.includes('Ganancia')) ? 'var(--color-win)' : 'var(--color-loss)';
                    this.ui.journalSummary.innerHTML = `<p style="font-size: 1.4em;"><strong>Resultado:</strong> <span style="color: ${resultColor};">${resultText}</span></p><p>Balance Final: $${this.state.currentBalance.toFixed(2)} ($${profitLoss.toFixed(2)})</p><p><strong>Operaciones Totales:</strong> ${this.state.history.length}</p>`;
                    this.ui.journalCard.classList.remove('hidden');
                },

                renderHistory() {
                    let tableHTML = `<table><thead><tr><th>Op#</th><th>Invertido</th><th>Resultado</th><th>G/P</th><th>Balance</th></tr></thead><tbody>`;
                    for (const op of this.state.history) {
                        const rowClass = op.result === 'WIN' ? 'win-row' : 'loss-row';
                        const resultColor = op.netResult >= 0 ? 'var(--color-secondary)' : 'var(--color-loss)';
                        tableHTML += `<tr class="${rowClass}"><td>${op.op}</td><td>$${op.investment.toFixed(2)}</td><td>${op.result}</td><td style="color: ${resultColor}">$${op.netResult.toFixed(2)}</td><td>$${op.balance.toFixed(2)}</td></tr>`;
                    }
                    this.ui.tableContent.innerHTML = tableHTML + '</tbody></table>';
                },
                
                updateLivePanel() {
                    let totalOps = "∞";
                    if (this.state.strategy === 'masaniello') totalOps = this.state.masaniello.totalTrades;
                    
                    this.ui.operationLabel.innerText = `OPERACIÓN #${this.state.operationNumber}`;
                    if (this.state.strategy === 'masaniello') this.ui.operationLabel.innerText += ` de ${totalOps}`;
                    
                    this.ui.investmentAmount.innerText = `$${this.state.lastInvestment.toFixed(2)}`;

                    if (this.state.strategy === 'gemhuel') {
                        const g = this.state.gemhuel;
                        this.ui.phaseDisplay.innerText = `FASE: ${g.phase}`;
                        this.ui.phaseDisplay.style.color = g.phase === 'Ataque' ? 'var(--color-secondary)' : 'var(--color-warning)';
                    } else {
                        this.ui.phaseDisplay.innerText = '';
                    }
                },

                updateUI() {
                    const strategy = this.ui.strategySelect.value;
                    const info = {
                        'gemhuel': { borderColor: 'var(--color-secondary)', title: '<strong>Riesgo:</strong> Inteligente', description: '<strong>Ideal para:</strong> Crecer reinvirtiendo ganancias. El riesgo solo aumenta después de ganar.', warning: '<strong>Advertencia:</strong> Mantén la disciplina y respeta tu plan de ciclo.' },
                        'masaniello': { borderColor: 'var(--color-primary)', title: '<strong>Riesgo:</strong> Calculado', description: '<strong>Ideal para:</strong> Alcanzar un objetivo con una tasa de aciertos predefinida.', warning: '<strong>Advertencia:</strong> Si fallas más de lo permitido, pierdes todo el capital del ciclo.' }
                    };
                    this.ui.strategyInfoBox.style.borderColor = info[strategy].borderColor;
                    this.ui.strategyInfoBox.innerHTML = `<p>${info[strategy].title}</p><p>${info[strategy].description}</p><p style="opacity: 0.8;">${info[strategy].warning}</p>`;
                    this.ui.masanielloGroup.classList.toggle('hidden', strategy !== 'masaniello');
                    this.ui.gemhuelGroup.classList.toggle('hidden', strategy !== 'gemhuel');
                }
            };
            
            App.init();
        });
    </script>
</body>
</html>
